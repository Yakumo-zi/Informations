# Vim从入门到精通

## vim哲学

### 核心概念：模式编辑

vim提供多种模式，按键在不同的模式下作用不同。**普通模式**下浏览文件，**插入模式**下插入文本，**可视模式**下选择行，**命令模式**下执行命令。

### 核心概念：操作符与动作

**操作符**是指开始某个行为，例如：修改/删除/选择等，开始某个行为之后需要用一个**动作**来指定需要操作的文本区域。

例如：`ci(`：change inner parentheses，作用为改变括号内的文本。`dap`：delete around paragraph，作用为删除整个段落。

## 基础

### 缓冲区，窗口，标签

**缓冲区**：文本作为缓冲区的一部分进行显示，每一份文件都有自己独有的缓冲区，插件显示的内容也在插件自己的缓冲区中。缓冲区有很多属性，包括标识缓冲区是否可以修改，缓冲区是否和文件关联，缓冲区是否需要同步到磁盘上。

**窗口**：可以用于同时查看几个文件或者查看同一文件的不同位置，窗口可以水平或者垂直分割，并且现有窗口的高度是和宽度都是可以被调节的。

**标签页（标签）**：是窗口的集合，支持多种窗口布局。

如果启动vim的时候没有带任何附加参数，默认是一个包含着呈现一个缓冲区的窗口的标签。

缓冲区是全局可见的，可以在任何标签中访问任何一个缓冲区。

### 已激活、已载入、已列出、已命名的缓冲区

用vim打开一个文件时，该文件的内容会被加载到缓冲区中，此时拥有一个**已载入的缓冲区**。如果在vim中保存整个文件，缓冲区的内容将会被同步到磁盘上。

由于这个缓冲区也在一个窗口上显示，所以他也是一个**已激活的缓冲区**。如果此时通过`:e file2`命令加载另一个文件，先前打开的文件将会变为**隐藏的缓冲区**，并且新打开的文件变为已激活缓冲区。

使用`:ls`可以列出所有缓冲区。插件缓冲区和帮助缓冲区通常标记为不可以列出的缓冲区。通过`:ls!`可以显示被放入缓冲区列表和未被放入列表的缓冲区。

**未命名的缓冲区**是一种没有关联特定文件的缓冲区，这种缓冲区经常被插件使用。比如 `:enew` 将会创建一个无名临时缓冲区。添加一些文本然后使用 `:w /tmp/foo` 将他写入到磁盘，这样这个缓冲区就会变成一个**已命名的缓冲区**。

### 按键映射

使用 `:map` 命令家族你可以定义属于你自己的快捷键。该家族的每一个命令都限定在特定的模式下。

| 递归  |  非递归   |         模式         |
| :---: | :-------: | :------------------: |
| :map  | :noremap  | n,v,operator-pending |
| :nmap | :nnoremap |          n           |
| :xmap | :xnoremap |          v           |
| :cmap | :cnoremap |     command-line     |
| :omap | :onoremap |   operator-pending   |
| :imap | :inoremap |          i           |

特定的映射命令只工作在特定的模式，例如：

```vimrc
:nmap <space> :echo "foo"<cr>
```

这个自定义的快捷键只工作在普通模式下

使用 `:nunmap <space>` 可以取消这个映射。

`:nmap` 是**递归执行**的，有以下例子：

```
:nmap b :echo "Foo"<cr>
```

然后再自定义一个映射，我们希望映射得到b原本的功能（回退到上一个单词）

```viml
:nmap a b
```

此时就会发生递归映射了，a会映射到`:echo "Foo"<cr>`上。

正确的方式是使用非递归映射替代：

```
:nnoremap a b 
```

**经验法则**：除递归映射是必须的，否则总是使用非递归映射。

可以使用`:map`命令来检查所有已映射的键，使用`:nmap`来检查普通模式下所有已映射的键。

如果你想禁止用标准映射，把他们映射到特殊字符 `<nop>` 上，例如：`:noremap <left> <nop>`。

### 映射前置键

映射前置键（Leader 键）本身就是一个按键映射，默认为 \。我们可以通过在 `map` 中调用 `<leader>` 来为把它添加到其他按键映射中。

```viml
let g:mapleader = ' '
nnoremap <leader>h :helpgrep<space>
```

此处建议使用 `g:mapleader`，因为在 Vim 脚本中，函数外的变量缺省的作用域是全局变量，但是在函数内缺省作用域是局部变量，而设置快捷键前缀需要修改全局变量 `g:mapleader` 的值。

### 寄存器

寄存器就是存储文本的地方。我们常用的「复制」操作就是把文本存储到寄存器，「 粘贴」 操作就是把文本从寄存器中读出来。顺便，在 Vim 中复制的快捷键是 y，粘贴的快捷键是 p。

![image-20231217233220906](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231217233220906.png)

### 范围

- 很多命令都可以加一个数字，用于指明操作范围
- 范围可以是一个行号，用于指定某一行
- 范围也可以是一对通过 `,` 或 `;` 分割的行号
- 大部分命令，默认只作用于当前行
- 只有 `:write` 和 `:global` 是默认作用于所有行的

范围的使用是十分直观的。以下为一些例子（其中，`:d` 为 `:delete` 的缩写）：

![image-20231217233719096](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231217233719096.png)

### 标注

可以使用标注功能来标记一个位置，也就是记录文件某行的某个位置。

![image-20231217233957766](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231217233957766.png)

如果想跳转到指定的标注，你可以先按下 `'` / `g'` 。

如果你想定义全局的标注，可以先按下 `m` 再按下大写英文字符。比如，按下 `mM` 就可以把当前文件的当前位置标注为 `M`。在这之后，就算你切换到其他的缓冲区，依然可以通过 `'M` 或 ``M` 跳转回来。

![image-20231217234330916](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231217234330916.png)

### 补全

Vim 在插入模式中为我们提供了多种补全方案。如果有多个补全结果，Vim 会弹出一个菜单供你选择。

常见的补全有标签、项目中引入的模块或库中的方法名、文件名、字典及当前缓冲区的字段。

针对不同的补全方案，Vim 为我们提供了不同的按键映射。这些映射都是在**插入模式中**通过 Ctrl + x 来触发：

![image-20231217234439910](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231217234439910.png)

### 变更历史

在 Vim 中，用户最近 100 次的文字改动都会被保存在**变更历史**中。如果在同一行有多个小改动，那么 Vim 会把它们合并成一个。尽管内容改动会合并，但作用的位置还是会只记录下最后一次改动的位置。

在你移动光标或跳转的时候，每一次的移动或跳转前的位置会被记录到**跳转历史**中。类似地，跳转历史也可以最多保存 100 条记录。对于每个窗口，跳转记录是独立的。但当你分离窗口时（比如使用 `:split` 命令），跳转历史会被复制过去。

![image-20231218114452166](./Vim%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A.assets/image-20231218114452166.png)

### 宏

你可以在 Vim 中录制一系列按键，并把他们存储到[寄存器](#寄存器)中。对于一些需要临时使用多次的一系列操作，把它们作为宏保存起来会显著地提升效率。对于一些复杂的操作，建议使用 Vim 脚本来实现。

- 首先，按下 q，然后按下你想要保存的寄存器，任何小写字母都可以。比如我们来把它保存到 `q` 这个寄存器中。按下 `qq`，你会发现命令行里已经显示了 "recording [@q]()"。
- 如果你已经录制完成，那么只需要再按一次 q 就可以结束录制。
- 如果你想调用刚才录制的宏，只需要 `[count]@q`
- 如果你想调用上一次使用的宏，只需要 `[count]@@`